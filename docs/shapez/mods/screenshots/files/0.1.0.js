/*!
 * screenshots version 0.1.0
 * source at https://github.com/EmeraldBlock/shapez.io-mods
 */(()=>{"use strict";const e={website:"https://emeraldblock.github.io/",author:"Emerald Block",name:"Superb Screenshots",version:"0.1.0",id:"screenshots",description:"Fixes and improves screenshots, plus new features",minimumGameVersion:">=1.5.0",doesNotAffectSavegame:!0,extra:{authors:[{name:"Emerald Block",icon:"https://avatars.githubusercontent.com/u/69981203"}],changelog:{"0.1.0":["Initial release","Make screenshots match ingame camera","Allow selecting screenshot region","Add quality, map view, wires layer, and transparent background options"]},source:"https://github.com/EmeraldBlock/shapez.io-mods",readme:'<p>Screenshots are buggy and broken! This mod fixes them (and makes them better).</p>\n<p>No more disappearing buildings. No more glitched items. And no more off-centered pixel distribution!</p>\n<p>Plus, now you can make map view screenshots! Or take one with a transparent background! You can even choose image quality! All with a fancy new screenshot dialog.</p>\n<p>This mod makes the screenshot code exactly match your ingame view. So change your game settings, and your screenshots will change to match!</p>\n<p>Yes, this used to be a <a href="https://github.com/tobspr/shapez.io/pull/1192" target="_blank">pull request</a> into the game itself, which has sat unclosed for over a year :( Here\'s the full fixes/changes/additions list, though!</p>\n<h3>Fixes</h3>\n<ul>\n    <li>Fixes buildings not rendering where the camera is.</li>\n    <li>Fixes item acceptors not processing their animations when taking a screenshot from map view.</li>\n    <li>Fixes the hub not rendering.</li>\n    <li>Fixes belt items not rendering.</li>\n</ul>\n<h3>Changes</h3>\n<ul>\n    <li>Shrinks the size of keybindings in dialogs (this also affects already-existing dialogs).</li>\n    <li>Changes the formatting of the toggle switch dialog form option.</li>\n    <li>Adds a 1-chunk border around base screenshots.</li>\n    <li>Changes the rendering code to mimic the game rendering code.</li>\n</ul>\n<h3>Additions</h3>\n<ul>\n    <li>Adds multiple target resolutions for screenshots.</li>\n    <li>Adds the ability to select a region (either the current mouse selection or the selected buildings) to take a screenshot of it.</li>\n    <li>Adds the ability to take a screenshot in map view.</li>\n    <li>Adds the ability to take a screenshot of the wires layer.</li>\n    <li>Adds the ability to take a screenshot with a transparent background.</li>\n    <li>Adds a toggle switch list dialog form option.</li>\n    <li>Adds a cycle button dialog form option.</li>\n    <li>Adds the ability to close the screenshot dialog with the key used to open it.</li>\n</ul>\n'}},{globalConfig:t}=window.shapez,{drawSpriteClipped:o}=window.shapez,{getBuildingDataFromCode:i}=window.shapez,{CHUNK_OVERLAY_RES:n,MapChunkView:a}=window.shapez,{THEME:s}=window.shapez;const{globalConfig:r}=window.shapez,{fastArrayDelete:l}=window.shapez,{ItemAcceptorSystem:c}=window.shapez;const{ClickDetector:h}=window.shapez,{createLogger:d}=window.shapez,{FormElement:g}=window.shapez,{safeModulo:u}=window.shapez,m=d("dialog_forms");class p extends g{constructor({id:e,label:t=null,checkboxes:o=[]}){super(e,t),this.checkboxes=o}getHtml(){return`\n            <div class="formElement checkBoxGridFormElem">\n                ${this.checkboxes.map((e=>e.getHtml())).join("\n")}\n            </div>\n        `}bindEvents(e,t){this.checkboxes.forEach((o=>o.bindEvents(e,t)))}getValue(){return this.checkboxes.map((e=>e.getValue()))}focus(){}}class w extends g{constructor({id:e,label:t=null,options:o,defaultValue:i=null,valueGetter:n,textGetter:a}){if(super(e,t),this.options=o,this.valueGetter=n,this.textGetter=a,this.index=0,null!==i){const e=this.options.findIndex((e=>e.id===i));e>=0?this.index=e:m.warn("Option ID",i,"not found in",o,"!")}this.element=null}getHtml(){return`\n            <div class="formElement enumFormElem">\n                ${this.label?`<label>${this.label}</label>`:""}\n                <div class="enum" data-formId="${this.id}">\n                    <div class="toggle prev">⯇</div>\n                    <div class="value">${this.textGetter(this.options[this.index])}</div>\n                    <div class="toggle next">⯈</div>\n                </div>\n            </div>\n            `}bindEvents(e,t){this.element=this.getFormElement(e);const o=this.element.children;for(let e=0;e<o.length;++e){const i=o[e],n=new h(i,{preventDefault:!1});t.push(n);const a=i.classList.contains("prev")?-1:1;n.click.add((()=>this.toggle(a)),this)}}getValue(){return this.valueGetter(this.options[this.index])}toggle(e){this.index=u(this.index+e,this.options.length),this.element.querySelector(".value").innerText=this.textGetter(this.options[this.index])}focus(){}}const{makeOffscreenBuffer:y}=window.shapez,{globalConfig:f}=window.shapez,{DrawParameters:x}=window.shapez,{createLogger:b}=window.shapez,{DialogWithForm:k}=window.shapez,{FormElementCheckbox:v}=window.shapez,{Rectangle:S}=window.shapez,{ORIGINAL_SPRITE_SCALE:z}=window.shapez,{clamp:C}=window.shapez,{Vector:M}=window.shapez,{StaticMapEntityComponent:E}=window.shapez,{HUDMassSelector:I}=window.shapez,{HUDScreenshotExporter:A}=window.shapez,{KEYMAPPINGS:B}=window.shapez,{CHUNK_OVERLAY_RES:D,MapChunkView:F}=window.shapez,{enumHubGoalRewards:T}=window.shapez,{T:O}=window.shapez,V=b("screenshot_exporter"),L=16384,G=[{id:"high",resolution:L},{id:"medium",resolution:4096},{id:"low",resolution:1024},{id:"pixels",resolution:0}],R={high:"High",medium:"Medium",low:"Low",pixels:"Pixels"};const{Mod:P}=window.shapez;window.$shapez_registerMod(class extends P{init(){this.modInterface.registerCss('button,.increasedClickArea{position:relative}.ingameDialog>.dialogInner>.content .keybinding{font-size:calc(10px * var(--ui-scale));line-height:calc(13px * var(--ui-scale));font-weight:400;font-family:"GameFont",sans-serif;letter-spacing:.01em}.ingameDialog>.dialogInner>.content .checkBoxFormElem,.ingameDialog>.dialogInner>.content .enumFormElem{display:flex;align-items:center;margin:calc(10px * var(--ui-scale)) calc(0px * var(--ui-scale))}.ingameDialog>.dialogInner>.content .checkBoxFormElem>label,.ingameDialog>.dialogInner>.content .enumFormElem>label{margin-right:calc(10px * var(--ui-scale))}.ingameDialog>.dialogInner>.content .checkBoxGridFormElem{display:inline-grid;grid-template-columns:1fr;margin:calc(10px * var(--ui-scale)) calc(0px * var(--ui-scale));grid-row-gap:calc(10px * var(--ui-scale))}.ingameDialog>.dialogInner>.content .checkBoxGridFormElem>.checkBoxFormElem{margin:0;justify-content:space-between}.ingameDialog>.dialogInner>.content .enum{display:grid;grid-template-columns:auto 1fr auto;grid-gap:calc(4px * var(--ui-scale));min-width:calc(160px * var(--ui-scale))}.ingameDialog>.dialogInner>.content .enum>div{background:#dee1ea;display:flex;justify-content:center;align-items:center;text-align:center;pointer-events:all;cursor:pointer;border-radius:calc(6px * var(--ui-scale));padding:calc(4px * var(--ui-scale));transition:background-color .12s ease-in-out}.ingameDialog>.dialogInner>.content .enum>div:hover{background-color:#ced3e0}html[data-theme=dark] .ingameDialog>.dialogInner>.content .enum>div,.ingameDialog>.dialogInner>.content .enum>div[data-theme=dark]{background-color:#484c58;color:#ddd}html[data-theme=dark] .ingameDialog>.dialogInner>.content .enum>div:hover,.ingameDialog>.dialogInner>.content .enum>div[data-theme=dark]:hover{background-color:#434752}.ingameDialog>.dialogInner>.content .enum>div.toggle{width:calc(16px * var(--ui-scale))}.ingameDialog>.dialogInner>.content .enum>div.value{transform:none !important}'),this.modInterface.extendClass(a,(()=>({drawBackgroundLayerBeltsOnly(e){const t=this.root.systemMgr.systems;t.beltUnderlays.drawChunk(e,this),t.belt.drawChunk(e,this)},drawOverlayNoBackground(e){const i=t.mapChunkSize*n,a=this.root.buffers.getForKey({key:"chunknobg@"+this.root.currentLayer,subKey:this.renderKey,w:i,h:i,dpi:1,redrawMethod:this.generateOverlayBufferNoBackground.bind(this)}),s=t.mapChunkWorldSize,r=.05;e.context.imageSmoothingEnabled=!1,o({parameters:e,sprite:a,x:this.x*s-r,y:this.y*s-r,w:s+.1,h:s+.1,originalW:i,originalH:i}),e.context.imageSmoothingEnabled=!0},generateOverlayBufferNoBackground(e,o,r,l,c){for(let e=0;e<t.mapChunkSize;++e){const a=this.contents[e];for(let s=0;s<t.mapChunkSize;++s){const t=a[s];if(t){const a=t.components.StaticMapEntity,r=i(a.code),l=r.metaInstance,c=l.getSpecialOverlayRenderMatrix(a.rotation,r.rotationVariant,r.variant,t);if(c){o.fillStyle=l.getSilhouetteColor(r.variant,r.rotationVariant);for(let t=0;t<3;++t)for(let i=0;i<3;++i)c[t+3*i]&&o.fillRect(e*n+t,s*n+i,1,1);continue}o.fillStyle=l.getSilhouetteColor(r.variant,r.rotationVariant),o.fillRect(e*n,s*n,n,n)}}}if("wires"===this.root.currentLayer){o.fillStyle=s.map.wires.overlayColor,o.fillRect(0,0,r,l);for(let e=0;e<t.mapChunkSize;++e){const i=this.wireContents[e];for(let s=0;s<t.mapChunkSize;++s){const t=i[s];t&&a.drawSingleWiresOverviewTile({context:o,x:e*n,y:s*n,entity:t,tileSizePixels:n})}}}}}))),function(e){e.modInterface.extendClass(c,(()=>({updateForScreenshot(){const e=this.accumulatedTicksWhileInMapOverview,t=2*this.root.dynamicTickrate.deltaSeconds*this.root.hubGoals.getBeltBaseSpeed()*r.itemSpacingOnBelts*e;this.accumulatedTicksWhileInMapOverview=0;for(let e=0;e<this.allEntities.length;++e){const o=this.allEntities[e].components.ItemAcceptor.itemConsumptionAnimations;for(let e=0;e<o.length;++e){const i=o[e];i.animProgress+=t,i.animProgress>1&&(l(o,e),e-=1)}}}})))}(this),function(e){e.modInterface.extendClass(A,(()=>({startExport(){if(!this.root.app.restrictionMgr.getIsExportingScreenshotsPossible())return void this.root.hud.parts.dialogs.showFeatureRestrictionInfo(O.demo.features.exportingBase);let e;const t=this.root.hud.parts.massSelector;if(t instanceof I)if(t.currentSelectionStartWorld){const o=t.currentSelectionStartWorld,i=this.root.camera.screenToWorld(t.currentSelectionEnd),n=o.toTileSpace(),a=i.toTileSpace();e=S.fromTwoPoints(n,a),e.w+=1,e.h+=1}else if(t.selectedUids.size>0){const o=new M(1/0,1/0),i=new M(-1/0,-1/0),n=Array.from(t.selectedUids);for(let e=0;e<n.length;++e){const t=this.root.entityMgr.findByUid(n[e]).components.StaticMapEntity.getTileSpaceBounds();o.x=Math.min(o.x,t.x),o.y=Math.min(o.y,t.y),i.x=Math.max(i.x,t.x+t.w),i.y=Math.max(i.y,t.y+t.h)}e=S.fromTwoPoints(o,i)}const o=new w({id:"screenshotQuality",label:"Quality",options:G,defaultValue:"medium",valueGetter:e=>e.resolution,textGetter:e=>R[e.id]}),i=new v({id:"screenshotView",label:"Map view",defaultValue:!!this.root.camera.getIsMapOverlayActive()}),n=new v({id:"screenshotLayer",label:"Wires layer",defaultValue:"wires"===this.root.currentLayer}),a=new v({id:"screenshotBackground",label:"Transparent background",defaultValue:!1}),s=new p({id:"screenshotCheckboxes",checkboxes:[i,...this.root.hubGoals.isRewardUnlocked(T.reward_wires_painter_and_levers)?[n]:[],a]}),r=new k({app:this.root.app,title:O.dialogs.exportScreenshotWarning.title,desc:e?"You requested to export a region of your base as a screenshot. Please note that this will be quite slow for a bigger region and could potentially crash your game!":"You requested to export your base as a screenshot. Please note that this will be quite slow for a bigger base and could potentially crash your game!"+(this.root.app.settings?.getAllSettings().offerHints?"<br><br>Tip: You can select a region with <key> to only take a screenshot of that region.".replace("<key>","<code class='keybinding'>"+this.root.keyMapper.getBinding(B.massSelect.massSelectStart).getKeyCodeString()+"</code>"):""),formElements:[o,s],buttons:["cancel:good","ok:bad"]});r.inputReciever.keydown.add((({keyCode:e})=>{e===B.ingame.exportScreenshot.keyCode&&this.root.hud.parts.dialogs.closeDialog(r)})),this.root.hud.parts.dialogs.internalShowDialog(r),r.buttonSignals.ok.add((()=>this.doExport(o.getValue(),i.getValue(),n.getValue(),a.getValue(),!!e,e)),this)},doExport(e,t,o,i,n,a){V.log("Starting export ...");const s=!!a;if(!a){const e=this.root.entityMgr.getAllWithComponent(E),t=new M(0,0),o=new M(0,0);for(let i=0;i<e.length;++i){const n=e[i].components.StaticMapEntity.getTileSpaceBounds();t.x=Math.min(t.x,n.x),t.y=Math.min(t.y,n.y),o.x=Math.max(o.x,n.x+n.w),o.y=Math.max(o.y,n.y+n.h)}t.x=Math.floor(t.x/f.mapChunkSize)*f.mapChunkSize,t.y=Math.floor(t.y/f.mapChunkSize)*f.mapChunkSize,o.x=Math.ceil(o.x/f.mapChunkSize)*f.mapChunkSize,o.y=Math.ceil(o.y/f.mapChunkSize)*f.mapChunkSize,a=S.fromTwoPoints(t,o).expandedInAllDirections(f.mapChunkSize)}const r=n&&!t&&e/(Math.max(a.w,a.h)+2/3)>=9,l=r?a.expandedInAllDirections(1/3):a;V.log("Bounds:",l);const c=Math.max(l.w,l.h),h=C(e/(c+(r?2/3:0)),3,f.assetsDpi*f.tileSize),d=r?3:1,g=t?Math.floor(h/D)*D||D:Math.floor((h+d)/(2*d))*(2*d)-d||d;if(V.log("Pixels per tile:",g),Math.round(g*c)>L)return V.error("Maximum canvas size exceeded, aborting"),void this.root.hud.parts.dialogs.showInfo("Too large",s?"The region selected is too large to render, sorry! Try selecting a smaller region.":"The base is too large to render, sorry! Try selecting just a region of your base with <key>.".replace("<key>","<code class='keybinding'>"+this.root.keyMapper.getBinding(B.massSelect.massSelectStart).getKeyCodeString()+"</code>"));const u=g/f.tileSize;V.log("Scale:",u);const m=this.root.app.settings.getAllSettings().lowQualityTextures,p=u/f.assetsDpi*f.assetsSharpness;let w="0.25";p>.5&&!m?w=z:p>.35&&!m&&(w="0.5"),V.log("Allocating buffer, if the factory grew too big it will crash here");const[b,k]=y(Math.round(l.w*g),Math.round(l.h*g),{smooth:!0,reusable:!1,label:"export-buffer"});V.log("Got buffer, rendering now ...");const v=l.allScaled(f.tileSize),I=new x({context:k,visibleRect:v,desiredAtlasScale:w,root:this.root,zoomLevel:u});k.scale(u,u),k.translate(-v.x,-v.y);const A=this.root.currentLayer,T=this.root.hud.parts.wiresOverlay.currentAlpha;o?(this.root.currentLayer="wires",this.root.hud.parts.wiresOverlay.currentAlpha=1):(this.root.currentLayer="regular",this.root.hud.parts.wiresOverlay.currentAlpha=0),this.root.systemMgr.systems.itemAcceptor.updateForScreenshot(),this.root.signals.gameFrameStarted.dispatch(),t?(this.root,i?this.root.map.drawVisibleChunks(I,F.prototype.drawOverlayNoBackground):this.root.map.drawOverlay(I)):(i?this.root.map.drawVisibleChunks(I,F.prototype.drawBackgroundLayerBeltsOnly):this.root.map.drawBackground(I),this.root.systemMgr.systems.belt.drawBeltItems(I),this.root.map.drawForeground(I),this.root.systemMgr.systems.hub.draw(I),this.root.hud.parts.wiresOverlay&&this.root.hud.parts.wiresOverlay.draw(I),"wires"===this.root.currentLayer&&this.root.map.drawWiresForegroundLayer(I)),this.root.currentLayer=A,this.root.hud.parts.wiresOverlay.currentAlpha=T,V.log("Rendered buffer, exporting ...");const O=b.toDataURL("image/png"),G=document.createElement("a");G.download="base.png",G.href=O,G.click(),V.log("Done!")}})))}(this)}},e)})();
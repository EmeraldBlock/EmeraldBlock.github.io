/*!
 * screenshots version 0.1.1
 *     source at https://github.com/EmeraldBlock/shapez.io-mods
 */(()=>{"use strict";const e={website:"https://emeraldblock.github.io/",author:"Emerald Block",name:"Superb Screenshots",version:"0.1.1",id:"screenshots",description:"Fixes and improves screenshots, plus new features",minimumGameVersion:">=1.5.0",doesNotAffectSavegame:!0,extra:{authors:[{name:"Emerald Block",icon:"https://avatars.githubusercontent.com/u/69981203"}],changelog:{"0.1.1":["Added icon","Edited readme"],"0.1.0":["Initial release","Make screenshots match ingame camera","Allow selecting screenshot region","Add quality, map view, wires layer, and transparent background options"]},source:"https://github.com/EmeraldBlock/shapez.io-mods",readme:'<p>Screenshots are buggy and broken! This mod fixes them (and makes them better).</p>\n<p>No more disappearing buildings. No more glitched items. And no more off-centered pixel distribution!</p>\n<p>Take screenshots of select regions of your base the same way you select blueprints. Say goodbye to image stitching!</p>\n<p>Plus, now you can make map view screenshots! Or take one with a transparent background! You can even choose image quality! All with a fancy new screenshot dialog.</p>\n<p>This mod makes the screenshot code exactly match your ingame view. So change your game settings, and your screenshots will change to match!</p>\n<p>Yes, this used to be a <a href="https://github.com/tobspr/shapez.io/pull/1192" target="_blank">pull request</a> into the game itself, which has sat unclosed for over a year :( Here\'s the full fixes/changes/additions list, though!</p>\n<h3>Fixes</h3>\n<ul>\n    <li>Fixes buildings not rendering where the camera is.</li>\n    <li>Fixes item acceptors not processing their animations when taking a screenshot from map view.</li>\n    <li>Fixes the hub not rendering.</li>\n    <li>Fixes belt items not rendering.</li>\n</ul>\n<h3>Changes</h3>\n<ul>\n    <li>Shrinks the size of keybindings in dialogs (this also affects already-existing dialogs).</li>\n    <li>Changes the formatting of the toggle switch dialog form option.</li>\n    <li>Adds a 1-chunk border around base screenshots.</li>\n    <li>Changes the rendering code to mimic the game rendering code.</li>\n</ul>\n<h3>Additions</h3>\n<ul>\n    <li>Adds multiple target resolutions for screenshots.</li>\n    <li>Adds the ability to select a region (either the current mouse selection or the selected buildings) to take a screenshot of it.</li>\n    <li>Adds the ability to take a screenshot in map view.</li>\n    <li>Adds the ability to take a screenshot of the wires layer.</li>\n    <li>Adds the ability to take a screenshot with a transparent background.</li>\n    <li>Adds a toggle switch list dialog form option.</li>\n    <li>Adds a cycle button dialog form option.</li>\n    <li>Adds the ability to close the screenshot dialog with the key used to open it.</li>\n</ul>\n'}},{globalConfig:t}=window.shapez,{drawSpriteClipped:o}=window.shapez,{getBuildingDataFromCode:i}=window.shapez,{CHUNK_OVERLAY_RES:n,MapChunkView:a}=window.shapez,{THEME:s}=window.shapez;const{globalConfig:r}=window.shapez,{fastArrayDelete:l}=window.shapez,{ItemAcceptorSystem:A}=window.shapez;const{ClickDetector:c}=window.shapez,{createLogger:h}=window.shapez,{FormElement:d}=window.shapez,{safeModulo:g}=window.shapez,u=h("dialog_forms");class m extends d{constructor({id:e,label:t=null,checkboxes:o=[]}){super(e,t),this.checkboxes=o}getHtml(){return`\n            <div class="formElement checkBoxGridFormElem">\n                ${this.checkboxes.map((e=>e.getHtml())).join("\n")}\n            </div>\n        `}bindEvents(e,t){this.checkboxes.forEach((o=>o.bindEvents(e,t)))}getValue(){return this.checkboxes.map((e=>e.getValue()))}focus(){}}class p extends d{constructor({id:e,label:t=null,options:o,defaultValue:i=null,valueGetter:n,textGetter:a}){if(super(e,t),this.options=o,this.valueGetter=n,this.textGetter=a,this.index=0,null!==i){const e=this.options.findIndex((e=>e.id===i));e>=0?this.index=e:u.warn("Option ID",i,"not found in",o,"!")}this.element=null}getHtml(){return`\n            <div class="formElement enumFormElem">\n                ${this.label?`<label>${this.label}</label>`:""}\n                <div class="enum" data-formId="${this.id}">\n                    <div class="toggle prev">⯇</div>\n                    <div class="value">${this.textGetter(this.options[this.index])}</div>\n                    <div class="toggle next">⯈</div>\n                </div>\n            </div>\n            `}bindEvents(e,t){this.element=this.getFormElement(e);const o=this.element.children;for(let e=0;e<o.length;++e){const i=o[e],n=new c(i,{preventDefault:!1});t.push(n);const a=i.classList.contains("prev")?-1:1;n.click.add((()=>this.toggle(a)),this)}}getValue(){return this.valueGetter(this.options[this.index])}toggle(e){this.index=g(this.index+e,this.options.length),this.element.querySelector(".value").innerText=this.textGetter(this.options[this.index])}focus(){}}const{makeOffscreenBuffer:w}=window.shapez,{globalConfig:y}=window.shapez,{DrawParameters:f}=window.shapez,{createLogger:b}=window.shapez,{DialogWithForm:x}=window.shapez,{FormElementCheckbox:k}=window.shapez,{Rectangle:v}=window.shapez,{ORIGINAL_SPRITE_SCALE:S}=window.shapez,{clamp:B}=window.shapez,{Vector:C}=window.shapez,{StaticMapEntityComponent:M}=window.shapez,{HUDMassSelector:E}=window.shapez,{HUDScreenshotExporter:z}=window.shapez,{KEYMAPPINGS:I}=window.shapez,{CHUNK_OVERLAY_RES:D,MapChunkView:F}=window.shapez,{enumHubGoalRewards:V}=window.shapez,{T}=window.shapez,W=b("screenshot_exporter"),G=16384,R=[{id:"high",resolution:G},{id:"medium",resolution:4096},{id:"low",resolution:1024},{id:"pixels",resolution:0}],H={high:"High",medium:"Medium",low:"Low",pixels:"Pixels"};const O=e;O.extra.icon="data:image/webp;base64,UklGRnQDAABXRUJQVlA4WAoAAAAgAAAA/wEA/wEASUNDUKACAAAAAAKgbGNtcwQwAABtbnRyUkdCIFhZWiAH5gAKABwAAQAPAB1hY3NwTVNGVAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA9tYAAQAAAADTLWxjbXMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA1kZXNjAAABIAAAAEBjcHJ0AAABYAAAADZ3dHB0AAABmAAAABRjaGFkAAABrAAAACxyWFlaAAAB2AAAABRiWFlaAAAB7AAAABRnWFlaAAACAAAAABRyVFJDAAACFAAAACBnVFJDAAACFAAAACBiVFJDAAACFAAAACBjaHJtAAACNAAAACRkbW5kAAACWAAAACRkbWRkAAACfAAAACRtbHVjAAAAAAAAAAEAAAAMZW5VUwAAACQAAAAcAEcASQBNAFAAIABiAHUAaQBsAHQALQBpAG4AIABzAFIARwBCbWx1YwAAAAAAAAABAAAADGVuVVMAAAAaAAAAHABQAHUAYgBsAGkAYwAgAEQAbwBtAGEAaQBuAABYWVogAAAAAAAA9tYAAQAAAADTLXNmMzIAAAAAAAEMQgAABd7///MlAAAHkwAA/ZD///uh///9ogAAA9wAAMBuWFlaIAAAAAAAAG+gAAA49QAAA5BYWVogAAAAAAAAJJ8AAA+EAAC2xFhZWiAAAAAAAABilwAAt4cAABjZcGFyYQAAAAAAAwAAAAJmZgAA8qcAAA1ZAAAT0AAACltjaHJtAAAAAAADAAAAAKPXAABUfAAATM0AAJmaAAAmZwAAD1xtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAEcASQBNAFBtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAHMAUgBHAEJWUDhMrQAAAC//wX8AJ0CQbSMxf4JBjOYa1yAQoAg7/L/lCSEBkfwPhplk/uP/JjOaABS1bSSVwlIYCkuh/GlVs+czEf2fAF+/Yn83/sN/+A9hKcZ/+A//IT21u13tfWrHf4Dt/H05/gNqtb3iisfyM67nxX8Ay9tnjvfz8+I/ANbfN2O3K8Z/AK2On83Yy+M/oLa/Yn83/gNieZ/a+9SO/wDbfRX7u/Ef/sN/CAz/43/8j9QBAA==";const{Mod:L}=window.shapez;window.$shapez_registerMod(class extends L{init(){this.modInterface.registerCss('button,.increasedClickArea{position:relative}.ingameDialog>.dialogInner>.content .keybinding{font-size:calc(10px * var(--ui-scale));line-height:calc(13px * var(--ui-scale));font-weight:400;font-family:"GameFont",sans-serif;letter-spacing:.01em}.ingameDialog>.dialogInner>.content .checkBoxFormElem,.ingameDialog>.dialogInner>.content .enumFormElem{display:flex;align-items:center;margin:calc(10px * var(--ui-scale)) calc(0px * var(--ui-scale))}.ingameDialog>.dialogInner>.content .checkBoxFormElem>label,.ingameDialog>.dialogInner>.content .enumFormElem>label{margin-right:calc(10px * var(--ui-scale))}.ingameDialog>.dialogInner>.content .checkBoxGridFormElem{display:inline-grid;grid-template-columns:1fr;margin:calc(10px * var(--ui-scale)) calc(0px * var(--ui-scale));grid-row-gap:calc(10px * var(--ui-scale))}.ingameDialog>.dialogInner>.content .checkBoxGridFormElem>.checkBoxFormElem{margin:0;justify-content:space-between}.ingameDialog>.dialogInner>.content .enum{display:grid;grid-template-columns:auto 1fr auto;grid-gap:calc(4px * var(--ui-scale));min-width:calc(160px * var(--ui-scale))}.ingameDialog>.dialogInner>.content .enum>div{background:#dee1ea;display:flex;justify-content:center;align-items:center;text-align:center;pointer-events:all;cursor:pointer;border-radius:calc(6px * var(--ui-scale));padding:calc(4px * var(--ui-scale));transition:background-color .12s ease-in-out}.ingameDialog>.dialogInner>.content .enum>div:hover{background-color:#ced3e0}html[data-theme=dark] .ingameDialog>.dialogInner>.content .enum>div,.ingameDialog>.dialogInner>.content .enum>div[data-theme=dark]{background-color:#484c58;color:#ddd}html[data-theme=dark] .ingameDialog>.dialogInner>.content .enum>div:hover,.ingameDialog>.dialogInner>.content .enum>div[data-theme=dark]:hover{background-color:#434752}.ingameDialog>.dialogInner>.content .enum>div.toggle{width:calc(16px * var(--ui-scale))}.ingameDialog>.dialogInner>.content .enum>div.value{transform:none !important}'),this.modInterface.extendClass(a,(()=>({drawBackgroundLayerBeltsOnly(e){const t=this.root.systemMgr.systems;t.beltUnderlays.drawChunk(e,this),t.belt.drawChunk(e,this)},drawOverlayNoBackground(e){const i=t.mapChunkSize*n,a=this.root.buffers.getForKey({key:"chunknobg@"+this.root.currentLayer,subKey:this.renderKey,w:i,h:i,dpi:1,redrawMethod:this.generateOverlayBufferNoBackground.bind(this)}),s=t.mapChunkWorldSize,r=.05;e.context.imageSmoothingEnabled=!1,o({parameters:e,sprite:a,x:this.x*s-r,y:this.y*s-r,w:s+.1,h:s+.1,originalW:i,originalH:i}),e.context.imageSmoothingEnabled=!0},generateOverlayBufferNoBackground(e,o,r,l,A){for(let e=0;e<t.mapChunkSize;++e){const a=this.contents[e];for(let s=0;s<t.mapChunkSize;++s){const t=a[s];if(t){const a=t.components.StaticMapEntity,r=i(a.code),l=r.metaInstance,A=l.getSpecialOverlayRenderMatrix(a.rotation,r.rotationVariant,r.variant,t);if(A){o.fillStyle=l.getSilhouetteColor(r.variant,r.rotationVariant);for(let t=0;t<3;++t)for(let i=0;i<3;++i)A[t+3*i]&&o.fillRect(e*n+t,s*n+i,1,1);continue}o.fillStyle=l.getSilhouetteColor(r.variant,r.rotationVariant),o.fillRect(e*n,s*n,n,n)}}}if("wires"===this.root.currentLayer){o.fillStyle=s.map.wires.overlayColor,o.fillRect(0,0,r,l);for(let e=0;e<t.mapChunkSize;++e){const i=this.wireContents[e];for(let s=0;s<t.mapChunkSize;++s){const t=i[s];t&&a.drawSingleWiresOverviewTile({context:o,x:e*n,y:s*n,entity:t,tileSizePixels:n})}}}}}))),function(e){e.modInterface.extendClass(A,(()=>({updateForScreenshot(){const e=this.accumulatedTicksWhileInMapOverview,t=2*this.root.dynamicTickrate.deltaSeconds*this.root.hubGoals.getBeltBaseSpeed()*r.itemSpacingOnBelts*e;this.accumulatedTicksWhileInMapOverview=0;for(let e=0;e<this.allEntities.length;++e){const o=this.allEntities[e].components.ItemAcceptor.itemConsumptionAnimations;for(let e=0;e<o.length;++e){const i=o[e];i.animProgress+=t,i.animProgress>1&&(l(o,e),e-=1)}}}})))}(this),function(e){e.modInterface.extendClass(z,(()=>({startExport(){if(!this.root.app.restrictionMgr.getIsExportingScreenshotsPossible())return void this.root.hud.parts.dialogs.showFeatureRestrictionInfo(T.demo.features.exportingBase);let e;const t=this.root.hud.parts.massSelector;if(t instanceof E)if(t.currentSelectionStartWorld){const o=t.currentSelectionStartWorld,i=this.root.camera.screenToWorld(t.currentSelectionEnd),n=o.toTileSpace(),a=i.toTileSpace();e=v.fromTwoPoints(n,a),e.w+=1,e.h+=1}else if(t.selectedUids.size>0){const o=new C(1/0,1/0),i=new C(-1/0,-1/0),n=Array.from(t.selectedUids);for(let e=0;e<n.length;++e){const t=this.root.entityMgr.findByUid(n[e]).components.StaticMapEntity.getTileSpaceBounds();o.x=Math.min(o.x,t.x),o.y=Math.min(o.y,t.y),i.x=Math.max(i.x,t.x+t.w),i.y=Math.max(i.y,t.y+t.h)}e=v.fromTwoPoints(o,i)}const o=new p({id:"screenshotQuality",label:"Quality",options:R,defaultValue:"medium",valueGetter:e=>e.resolution,textGetter:e=>H[e.id]}),i=new k({id:"screenshotView",label:"Map view",defaultValue:!!this.root.camera.getIsMapOverlayActive()}),n=new k({id:"screenshotLayer",label:"Wires layer",defaultValue:"wires"===this.root.currentLayer}),a=new k({id:"screenshotBackground",label:"Transparent background",defaultValue:!1}),s=new m({id:"screenshotCheckboxes",checkboxes:[i,...this.root.hubGoals.isRewardUnlocked(V.reward_wires_painter_and_levers)?[n]:[],a]}),r=new x({app:this.root.app,title:T.dialogs.exportScreenshotWarning.title,desc:e?"You requested to export a region of your base as a screenshot. Please note that this will be quite slow for a bigger region and could potentially crash your game!":"You requested to export your base as a screenshot. Please note that this will be quite slow for a bigger base and could potentially crash your game!"+(this.root.app.settings?.getAllSettings().offerHints?"<br><br>Tip: You can select a region with <key> to only take a screenshot of that region.".replace("<key>","<code class='keybinding'>"+this.root.keyMapper.getBinding(I.massSelect.massSelectStart).getKeyCodeString()+"</code>"):""),formElements:[o,s],buttons:["cancel:good","ok:bad"]});r.inputReciever.keydown.add((({keyCode:e})=>{e===I.ingame.exportScreenshot.keyCode&&this.root.hud.parts.dialogs.closeDialog(r)})),this.root.hud.parts.dialogs.internalShowDialog(r),r.buttonSignals.ok.add((()=>this.doExport(o.getValue(),i.getValue(),n.getValue(),a.getValue(),!!e,e)),this)},doExport(e,t,o,i,n,a){W.log("Starting export ...");const s=!!a;if(!a){const e=this.root.entityMgr.getAllWithComponent(M),t=new C(0,0),o=new C(0,0);for(let i=0;i<e.length;++i){const n=e[i].components.StaticMapEntity.getTileSpaceBounds();t.x=Math.min(t.x,n.x),t.y=Math.min(t.y,n.y),o.x=Math.max(o.x,n.x+n.w),o.y=Math.max(o.y,n.y+n.h)}t.x=Math.floor(t.x/y.mapChunkSize)*y.mapChunkSize,t.y=Math.floor(t.y/y.mapChunkSize)*y.mapChunkSize,o.x=Math.ceil(o.x/y.mapChunkSize)*y.mapChunkSize,o.y=Math.ceil(o.y/y.mapChunkSize)*y.mapChunkSize,a=v.fromTwoPoints(t,o).expandedInAllDirections(y.mapChunkSize)}const r=n&&!t&&e/(Math.max(a.w,a.h)+2/3)>=9,l=r?a.expandedInAllDirections(1/3):a;W.log("Bounds:",l);const A=Math.max(l.w,l.h),c=B(e/(A+(r?2/3:0)),3,y.assetsDpi*y.tileSize),h=r?3:1,d=t?Math.floor(c/D)*D||D:Math.floor((c+h)/(2*h))*(2*h)-h||h;if(W.log("Pixels per tile:",d),Math.round(d*A)>G)return W.error("Maximum canvas size exceeded, aborting"),void this.root.hud.parts.dialogs.showInfo("Too large",s?"The region selected is too large to render, sorry! Try selecting a smaller region.":"The base is too large to render, sorry! Try selecting just a region of your base with <key>.".replace("<key>","<code class='keybinding'>"+this.root.keyMapper.getBinding(I.massSelect.massSelectStart).getKeyCodeString()+"</code>"));const g=d/y.tileSize;W.log("Scale:",g);const u=this.root.app.settings.getAllSettings().lowQualityTextures,m=g/y.assetsDpi*y.assetsSharpness;let p="0.25";m>.5&&!u?p=S:m>.35&&!u&&(p="0.5"),W.log("Allocating buffer, if the factory grew too big it will crash here");const[b,x]=w(Math.round(l.w*d),Math.round(l.h*d),{smooth:!0,reusable:!1,label:"export-buffer"});W.log("Got buffer, rendering now ...");const k=l.allScaled(y.tileSize),E=new f({context:x,visibleRect:k,desiredAtlasScale:p,root:this.root,zoomLevel:g});x.scale(g,g),x.translate(-k.x,-k.y);const z=this.root.currentLayer,V=this.root.hud.parts.wiresOverlay.currentAlpha;o?(this.root.currentLayer="wires",this.root.hud.parts.wiresOverlay.currentAlpha=1):(this.root.currentLayer="regular",this.root.hud.parts.wiresOverlay.currentAlpha=0),this.root.systemMgr.systems.itemAcceptor.updateForScreenshot(),this.root.signals.gameFrameStarted.dispatch(),t?(this.root,i?this.root.map.drawVisibleChunks(E,F.prototype.drawOverlayNoBackground):this.root.map.drawOverlay(E)):(i?this.root.map.drawVisibleChunks(E,F.prototype.drawBackgroundLayerBeltsOnly):this.root.map.drawBackground(E),this.root.systemMgr.systems.belt.drawBeltItems(E),this.root.map.drawForeground(E),this.root.systemMgr.systems.hub.draw(E),this.root.hud.parts.wiresOverlay&&this.root.hud.parts.wiresOverlay.draw(E),"wires"===this.root.currentLayer&&this.root.map.drawWiresForegroundLayer(E)),this.root.currentLayer=z,this.root.hud.parts.wiresOverlay.currentAlpha=V,W.log("Rendered buffer, exporting ...");const T=b.toDataURL("image/png"),R=document.createElement("a");R.download="base.png",R.href=T,R.click(),W.log("Done!")}})))}(this)}},O)})();
/*!
 * screenshots version 0.1.2
 *     source at https://github.com/EmeraldBlock/shapez.io-mods
 */(()=>{"use strict";const e={website:"https://emeraldblock.github.io/",author:"Emerald Block",name:"Superb Screenshots",version:"0.1.2",id:"screenshots",description:"Fixes and improves screenshots, plus new features",minimumGameVersion:">=1.5.0",doesNotAffectSavegame:!0,extra:{authors:[{name:"Emerald Block",icon:"https://avatars.githubusercontent.com/u/69981203"}],changelog:{"0.1.2":["Added screenshot API"],"0.1.1":["Added icon","Edited readme"],"0.1.0":["Initial release","Make screenshots match ingame camera","Allow selecting screenshot region","Add quality, map view, wires layer, and transparent background options"]},source:"https://github.com/EmeraldBlock/shapez.io-mods",readme:'<p>Screenshots are buggy and broken! This mod fixes them (and makes them better).</p>\n<p>No more disappearing buildings. No more glitched items. And no more off-centered pixel distribution!</p>\n<p>Take screenshots of select regions of your base the same way you select blueprints. Say goodbye to image stitching!</p>\n<p>Plus, now you can make map view screenshots! Or take one with a transparent background! You can even choose image quality! All with a fancy new screenshot dialog.</p>\n<p>This mod makes the screenshot code exactly match your ingame view. So change your game settings, and your screenshots will change to match!</p>\n<p>Yes, this used to be a <a href="https://github.com/tobspr/shapez.io/pull/1192" target="_blank">pull request</a> into the game itself, which has sat unclosed for over a year :( Here\'s the full fixes/changes/additions list, though!</p>\n<h3>Fixes</h3>\n<ul>\n    <li>Fixes buildings not rendering where the camera is.</li>\n    <li>Fixes item acceptors not processing their animations when taking a screenshot from map view.</li>\n    <li>Fixes the hub not rendering.</li>\n    <li>Fixes belt items not rendering.</li>\n</ul>\n<h3>Changes</h3>\n<ul>\n    <li>Shrinks the size of keybindings in dialogs (this also affects already-existing dialogs).</li>\n    <li>Changes the formatting of the toggle switch dialog form option.</li>\n    <li>Adds a 1-chunk border around base screenshots.</li>\n    <li>Changes the rendering code to mimic the game rendering code.</li>\n</ul>\n<h3>Additions</h3>\n<ul>\n    <li>Adds multiple target resolutions for screenshots.</li>\n    <li>Adds the ability to select a region (either the current mouse selection or the selected buildings) to take a screenshot of it.</li>\n    <li>Adds the ability to take a screenshot in map view.</li>\n    <li>Adds the ability to take a screenshot of the wires layer.</li>\n    <li>Adds the ability to take a screenshot with a transparent background.</li>\n    <li>Adds a toggle switch list dialog form option.</li>\n    <li>Adds a cycle button dialog form option.</li>\n    <li>Adds the ability to close the screenshot dialog with the key used to open it.</li>\n</ul>\n'}},{globalConfig:t}=window.shapez,{drawSpriteClipped:i}=window.shapez,{getBuildingDataFromCode:o}=window.shapez,{CHUNK_OVERLAY_RES:n,MapChunkView:a}=window.shapez,{THEME:r}=window.shapez;const{globalConfig:s}=window.shapez,{fastArrayDelete:l}=window.shapez,{ItemAcceptorSystem:A}=window.shapez;const{ClickDetector:c}=window.shapez,{createLogger:d}=window.shapez,{FormElement:h}=window.shapez,{safeModulo:g}=window.shapez,u=d("dialog_forms");class m extends h{constructor({id:e,label:t=null,checkboxes:i=[]}){super(e,t),this.checkboxes=i}getHtml(){return`\n            <div class="formElement checkBoxGridFormElem">\n                ${this.checkboxes.map((e=>e.getHtml())).join("\n")}\n            </div>\n        `}bindEvents(e,t){this.checkboxes.forEach((i=>i.bindEvents(e,t)))}getValue(){return this.checkboxes.map((e=>e.getValue()))}focus(){}}class p extends h{constructor({id:e,label:t=null,options:i,defaultValue:o=null,valueGetter:n,textGetter:a}){if(super(e,t),this.options=i,this.valueGetter=n,this.textGetter=a,this.index=0,null!==o){const e=this.options.findIndex((e=>e.id===o));e>=0?this.index=e:u.warn("Option ID",o,"not found in",i,"!")}this.element=null}getHtml(){return`\n            <div class="formElement enumFormElem">\n                ${this.label?`<label>${this.label}</label>`:""}\n                <div class="enum" data-formId="${this.id}">\n                    <div class="toggle prev">⯇</div>\n                    <div class="value">${this.textGetter(this.options[this.index])}</div>\n                    <div class="toggle next">⯈</div>\n                </div>\n            </div>\n            `}bindEvents(e,t){this.element=this.getFormElement(e);const i=this.element.children;for(let e=0;e<i.length;++e){const o=i[e],n=new c(o,{preventDefault:!1});t.push(n);const a=o.classList.contains("prev")?-1:1;n.click.add((()=>this.toggle(a)),this)}}getValue(){return this.valueGetter(this.options[this.index])}toggle(e){this.index=g(this.index+e,this.options.length),this.element.querySelector(".value").innerText=this.textGetter(this.options[this.index])}focus(){}}const{makeOffscreenBuffer:w}=window.shapez,{globalConfig:y}=window.shapez,{DrawParameters:f}=window.shapez,{createLogger:b}=window.shapez,{DialogWithForm:x}=window.shapez,{FormElementCheckbox:k}=window.shapez,{Rectangle:v}=window.shapez,{ORIGINAL_SPRITE_SCALE:S}=window.shapez,{clamp:B}=window.shapez,{Vector:C}=window.shapez,{StaticMapEntityComponent:E}=window.shapez,{HUDMassSelector:M}=window.shapez,{HUDScreenshotExporter:z}=window.shapez,{KEYMAPPINGS:I}=window.shapez,{CHUNK_OVERLAY_RES:D,MapChunkView:F}=window.shapez,{enumHubGoalRewards:V}=window.shapez,{T:R}=window.shapez,T=b("screenshot_exporter"),W=16384,G=[{id:"high",resolution:W},{id:"medium",resolution:4096},{id:"low",resolution:1024},{id:"pixels",resolution:0}],H={high:"High",medium:"Medium",low:"Low",pixels:"Pixels"};function O(e,{targetResolution:t,overlay:i,wiresLayer:o,hideBackground:n,allowBorder:a,tileBounds:r}){if(T.log("Starting render ..."),!r){const t=e.entityMgr.getAllWithComponent(E),i=new C(0,0),o=new C(0,0);for(let e=0;e<t.length;++e){const n=t[e].components.StaticMapEntity.getTileSpaceBounds();i.x=Math.min(i.x,n.x),i.y=Math.min(i.y,n.y),o.x=Math.max(o.x,n.x+n.w),o.y=Math.max(o.y,n.y+n.h)}i.x=Math.floor(i.x/y.mapChunkSize)*y.mapChunkSize,i.y=Math.floor(i.y/y.mapChunkSize)*y.mapChunkSize,o.x=Math.ceil(o.x/y.mapChunkSize)*y.mapChunkSize,o.y=Math.ceil(o.y/y.mapChunkSize)*y.mapChunkSize,r=v.fromTwoPoints(i,o).expandedInAllDirections(y.mapChunkSize)}const s=a&&!i&&t/(Math.max(r.w,r.h)+2/3)>=9,l=s?r.expandedInAllDirections(1/3):r;T.log("Bounds:",l);const A=Math.max(l.w,l.h),c=B(t/(A+(s?2/3:0)),3,y.assetsDpi*y.tileSize),d=s?3:1,h=i?Math.floor(c/D)*D||D:Math.floor((c+d)/(2*d))*(2*d)-d||d;if(T.log("Pixels per tile:",h),Math.round(h*A)>W)return void T.error("Maximum canvas size exceeded, aborting");const g=h/y.tileSize;T.log("Scale:",g);const u=e.app.settings.getAllSettings().lowQualityTextures,m=g/y.assetsDpi*y.assetsSharpness;let p="0.25";m>.5&&!u?p=S:m>.35&&!u&&(p="0.5"),T.log("Allocating buffer, if the factory grew too big it will crash here");const[b,x]=w(Math.round(l.w*h),Math.round(l.h*h),{smooth:!0,reusable:!1,label:"export-buffer"});T.log("Got buffer, rendering now ...");const k=l.allScaled(y.tileSize),M=new f({context:x,visibleRect:k,desiredAtlasScale:p,root:e,zoomLevel:g});x.scale(g,g),x.translate(-k.x,-k.y);const z=e.currentLayer,I=e.hud.parts.wiresOverlay.currentAlpha;return o?(e.currentLayer="wires",e.hud.parts.wiresOverlay.currentAlpha=1):(e.currentLayer="regular",e.hud.parts.wiresOverlay.currentAlpha=0),e.systemMgr.systems.itemAcceptor.updateForScreenshot(),e.signals.gameFrameStarted.dispatch(),i?n?e.map.drawVisibleChunks(M,F.prototype.drawOverlayNoBackground):e.map.drawOverlay(M):(n?e.map.drawVisibleChunks(M,F.prototype.drawBackgroundLayerBeltsOnly):e.map.drawBackground(M),e.systemMgr.systems.belt.drawBeltItems(M),e.map.drawForeground(M),e.systemMgr.systems.hub.draw(M),e.hud.parts.wiresOverlay&&e.hud.parts.wiresOverlay.draw(M),"wires"===e.currentLayer&&e.map.drawWiresForegroundLayer(M)),e.currentLayer=z,e.hud.parts.wiresOverlay.currentAlpha=I,T.log("Rendered buffer"),b}const L=e;L.extra.icon="data:image/webp;base64,UklGRnQDAABXRUJQVlA4WAoAAAAgAAAA/wEA/wEASUNDUKACAAAAAAKgbGNtcwQwAABtbnRyUkdCIFhZWiAH5gAKABwAAQAPAB1hY3NwTVNGVAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA9tYAAQAAAADTLWxjbXMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA1kZXNjAAABIAAAAEBjcHJ0AAABYAAAADZ3dHB0AAABmAAAABRjaGFkAAABrAAAACxyWFlaAAAB2AAAABRiWFlaAAAB7AAAABRnWFlaAAACAAAAABRyVFJDAAACFAAAACBnVFJDAAACFAAAACBiVFJDAAACFAAAACBjaHJtAAACNAAAACRkbW5kAAACWAAAACRkbWRkAAACfAAAACRtbHVjAAAAAAAAAAEAAAAMZW5VUwAAACQAAAAcAEcASQBNAFAAIABiAHUAaQBsAHQALQBpAG4AIABzAFIARwBCbWx1YwAAAAAAAAABAAAADGVuVVMAAAAaAAAAHABQAHUAYgBsAGkAYwAgAEQAbwBtAGEAaQBuAABYWVogAAAAAAAA9tYAAQAAAADTLXNmMzIAAAAAAAEMQgAABd7///MlAAAHkwAA/ZD///uh///9ogAAA9wAAMBuWFlaIAAAAAAAAG+gAAA49QAAA5BYWVogAAAAAAAAJJ8AAA+EAAC2xFhZWiAAAAAAAABilwAAt4cAABjZcGFyYQAAAAAAAwAAAAJmZgAA8qcAAA1ZAAAT0AAACltjaHJtAAAAAAADAAAAAKPXAABUfAAATM0AAJmaAAAmZwAAD1xtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAEcASQBNAFBtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAAgAAAAcAHMAUgBHAEJWUDhMrQAAAC//wX8AJ0CQbSMxf4JBjOYa1yAQoAg7/L/lCSEBkfwPhplk/uP/JjOaABS1bSSVwlIYCkuh/GlVs+czEf2fAF+/Yn83/sN/+A9hKcZ/+A//IT21u13tfWrHf4Dt/H05/gNqtb3iisfyM67nxX8Ay9tnjvfz8+I/ANbfN2O3K8Z/AK2On83Yy+M/oLa/Yn83/gNieZ/a+9SO/wDbfRX7u/Ef/sN/CAz/43/8j9QBAA==";const{Mod:N}=window.shapez;window.$shapez_registerMod(class extends N{init(){this.modInterface.registerCss('button,.increasedClickArea{position:relative}.ingameDialog>.dialogInner>.content .keybinding{font-size:calc(10px * var(--ui-scale));line-height:calc(13px * var(--ui-scale));font-weight:400;font-family:"GameFont",sans-serif;letter-spacing:.01em}.ingameDialog>.dialogInner>.content .checkBoxFormElem,.ingameDialog>.dialogInner>.content .enumFormElem{display:flex;align-items:center;margin:calc(10px * var(--ui-scale)) calc(0px * var(--ui-scale))}.ingameDialog>.dialogInner>.content .checkBoxFormElem>label,.ingameDialog>.dialogInner>.content .enumFormElem>label{margin-right:calc(10px * var(--ui-scale))}.ingameDialog>.dialogInner>.content .checkBoxGridFormElem{display:inline-grid;grid-template-columns:1fr;margin:calc(10px * var(--ui-scale)) calc(0px * var(--ui-scale));grid-row-gap:calc(10px * var(--ui-scale))}.ingameDialog>.dialogInner>.content .checkBoxGridFormElem>.checkBoxFormElem{margin:0;justify-content:space-between}.ingameDialog>.dialogInner>.content .enum{display:grid;grid-template-columns:auto 1fr auto;grid-gap:calc(4px * var(--ui-scale));min-width:calc(160px * var(--ui-scale))}.ingameDialog>.dialogInner>.content .enum>div{background:#dee1ea;display:flex;justify-content:center;align-items:center;text-align:center;pointer-events:all;cursor:pointer;border-radius:calc(6px * var(--ui-scale));padding:calc(4px * var(--ui-scale));transition:background-color .12s ease-in-out}.ingameDialog>.dialogInner>.content .enum>div:hover{background-color:#ced3e0}html[data-theme=dark] .ingameDialog>.dialogInner>.content .enum>div,.ingameDialog>.dialogInner>.content .enum>div[data-theme=dark]{background-color:#484c58;color:#ddd}html[data-theme=dark] .ingameDialog>.dialogInner>.content .enum>div:hover,.ingameDialog>.dialogInner>.content .enum>div[data-theme=dark]:hover{background-color:#434752}.ingameDialog>.dialogInner>.content .enum>div.toggle{width:calc(16px * var(--ui-scale))}.ingameDialog>.dialogInner>.content .enum>div.value{transform:none !important}'),this.modInterface.extendClass(a,(()=>({drawBackgroundLayerBeltsOnly(e){const t=this.root.systemMgr.systems;t.beltUnderlays.drawChunk(e,this),t.belt.drawChunk(e,this)},drawOverlayNoBackground(e){const o=t.mapChunkSize*n,a=this.root.buffers.getForKey({key:"chunknobg@"+this.root.currentLayer,subKey:this.renderKey,w:o,h:o,dpi:1,redrawMethod:this.generateOverlayBufferNoBackground.bind(this)}),r=t.mapChunkWorldSize,s=.05;e.context.imageSmoothingEnabled=!1,i({parameters:e,sprite:a,x:this.x*r-s,y:this.y*r-s,w:r+.1,h:r+.1,originalW:o,originalH:o}),e.context.imageSmoothingEnabled=!0},generateOverlayBufferNoBackground(e,i,s,l,A){for(let e=0;e<t.mapChunkSize;++e){const a=this.contents[e];for(let r=0;r<t.mapChunkSize;++r){const t=a[r];if(t){const a=t.components.StaticMapEntity,s=o(a.code),l=s.metaInstance,A=l.getSpecialOverlayRenderMatrix(a.rotation,s.rotationVariant,s.variant,t);if(A){i.fillStyle=l.getSilhouetteColor(s.variant,s.rotationVariant);for(let t=0;t<3;++t)for(let o=0;o<3;++o)A[t+3*o]&&i.fillRect(e*n+t,r*n+o,1,1);continue}i.fillStyle=l.getSilhouetteColor(s.variant,s.rotationVariant),i.fillRect(e*n,r*n,n,n)}}}if("wires"===this.root.currentLayer){i.fillStyle=r.map.wires.overlayColor,i.fillRect(0,0,s,l);for(let e=0;e<t.mapChunkSize;++e){const o=this.wireContents[e];for(let r=0;r<t.mapChunkSize;++r){const t=o[r];t&&a.drawSingleWiresOverviewTile({context:i,x:e*n,y:r*n,entity:t,tileSizePixels:n})}}}}}))),function(e){e.modInterface.extendClass(A,(()=>({updateForScreenshot(){const e=this.accumulatedTicksWhileInMapOverview,t=2*this.root.dynamicTickrate.deltaSeconds*this.root.hubGoals.getBeltBaseSpeed()*s.itemSpacingOnBelts*e;this.accumulatedTicksWhileInMapOverview=0;for(let e=0;e<this.allEntities.length;++e){const i=this.allEntities[e].components.ItemAcceptor.itemConsumptionAnimations;for(let e=0;e<i.length;++e){const o=i[e];o.animProgress+=t,o.animProgress>1&&(l(i,e),e-=1)}}}})))}(this),function(e){e.modInterface.extendClass(z,(()=>({startExport(){if(!this.root.app.restrictionMgr.getIsExportingScreenshotsPossible())return void this.root.hud.parts.dialogs.showFeatureRestrictionInfo(R.demo.features.exportingBase);let e;const t=this.root.hud.parts.massSelector;if(t instanceof M)if(t.currentSelectionStartWorld){const i=t.currentSelectionStartWorld,o=this.root.camera.screenToWorld(t.currentSelectionEnd),n=i.toTileSpace(),a=o.toTileSpace();e=v.fromTwoPoints(n,a),e.w+=1,e.h+=1}else if(t.selectedUids.size>0){const i=new C(1/0,1/0),o=new C(-1/0,-1/0),n=Array.from(t.selectedUids);for(let e=0;e<n.length;++e){const t=this.root.entityMgr.findByUid(n[e]).components.StaticMapEntity.getTileSpaceBounds();i.x=Math.min(i.x,t.x),i.y=Math.min(i.y,t.y),o.x=Math.max(o.x,t.x+t.w),o.y=Math.max(o.y,t.y+t.h)}e=v.fromTwoPoints(i,o)}const i=new p({id:"screenshotQuality",label:"Quality",options:G,defaultValue:"medium",valueGetter:e=>e.resolution,textGetter:e=>H[e.id]}),o=new k({id:"screenshotView",label:"Map view",defaultValue:this.root.camera.getIsMapOverlayActive()}),n=new k({id:"screenshotLayer",label:"Wires layer",defaultValue:"wires"===this.root.currentLayer}),a=new k({id:"screenshotBackground",label:"Transparent background",defaultValue:!1}),r=new m({id:"screenshotCheckboxes",checkboxes:[o,...this.root.hubGoals.isRewardUnlocked(V.reward_wires_painter_and_levers)?[n]:[],a]}),s=new x({app:this.root.app,title:R.dialogs.exportScreenshotWarning.title,desc:e?"You requested to export a region of your base as a screenshot. Please note that this will be quite slow for a bigger region and could potentially crash your game!":"You requested to export your base as a screenshot. Please note that this will be quite slow for a bigger base and could potentially crash your game!"+(this.root.app.settings?.getAllSettings().offerHints?"<br><br>Tip: You can select a region with <key> to only take a screenshot of that region.".replace("<key>","<code class='keybinding'>"+this.root.keyMapper.getBinding(I.massSelect.massSelectStart).getKeyCodeString()+"</code>"):""),formElements:[i,r],buttons:["cancel:good","ok:bad"]});s.inputReciever.keydown.add((({keyCode:e})=>{e===I.ingame.exportScreenshot.keyCode&&this.root.hud.parts.dialogs.closeDialog(s)})),this.root.hud.parts.dialogs.internalShowDialog(s),s.buttonSignals.ok.add((()=>this.doExport(i.getValue(),o.getValue(),n.getValue(),a.getValue(),!!e,e)),this)},doExport(e,t,i,o,n,a){const r=O(this.root,{targetResolution:e,overlay:t,wiresLayer:i,hideBackground:o,allowBorder:n,tileBounds:a});if(void 0===r)return void this.root.hud.parts.dialogs.showInfo("Too large",a?"The region selected is too large to render, sorry! Try selecting a smaller region.":"The base is too large to render, sorry! Try selecting just a region of your base with <key>.".replace("<key>","<code class='keybinding'>"+this.root.keyMapper.getBinding(I.massSelect.massSelectStart).getKeyCodeString()+"</code>"));T.log("Exporting ...");const s=r.toDataURL("image/png"),l=document.createElement("a");l.download="base.png",l.href=s,l.click(),T.log("Done!")}})))}(this)}takeScreenshot(e,t){return O(e,t)}},L)})();